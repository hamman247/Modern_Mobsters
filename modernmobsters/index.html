<!DOCTYPE html>
<html lang="en">
<head>
  <title>Modern Mobsters</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="css/bootstrap.min.css">
  <link rel="stylesheet" href="css/main.css">
  <script src="js/jquery.min.js"></script>
  <script src="Js/popper.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.5.1.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
  <script src="Js/bootstrap.min.js"></script>
  <!--<script src="./bundle.js"></script>-->
</head>
<body>

<div class="container-fluid" >
  <div  class="mt30"></div>
  <div>
  
  <div class="row">
<div class="col-md-5"></div>
<div class="col-md-2">
  <div  class="mt30"></div>
 
  <img src="img/sc23.png" class="Logo1"/>
  <img src="img/sc23.png" class="Logo2" style="display: none;"/>

</div>
<div class="col-md-5"></div>

    
  </div>
  <div class="row">
    <div  class="mt30"></div>
    <div class="col-md-4">
      <div  class="mt130"></div>
      <img src="img/sc25.png"  class="sc25R"/>
    </div>
    <div class="col-md-4">     
     <div class="innerdiv">
      <div  class="mt30"></div>
      <div class="text-center">
<div  class="mt30"></div>
                
          <br/>
          <br/>
          
          <div id="connect" style="display: block;">
              <div class="header" align="center">
                  <a class="connectButton" style="display: block; cursor: pointer; pointer-events: all; visibility: visible;"><img src="img/sc28.png" class="connectButton"/></a>
              </div>
          </div> 
          <div id="mintNFT" style="display: none;">
              <div>
                 <p id="amountLeft" style="font-weight: bold;"></p>
              </div>
              <div align="center">
                  <a class="mintNFTButton" style="display: block; cursor: pointer; pointer-events: all; visibility: visible;"><img src="img/sc27.png" class="mintNFTButton"/></a>
              </div>
              <div align="center">
                 <label for="amountNFTs" style="font-weight: bold;">Amount to Mint:</label>
                 <select name="amountNFTs" id="amountNFTs" style="background: #ffffff; font-weight: bold;">
                    <option value="1">1</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                    <option value="4">4</option>
                    <option value="5">5</option>
                    <option value="6">6</option>
                    <option value="7">7</option>
                    <option value="8">8</option>
                    <option value="9">9</option>
                    <option value="10">10</option>
                 </select>
              </div> 
           </div> 
          
        <br/>
        <br/>
        <div  class="mt30"></div>
  
        <div class="row">
          <div class="col-md-3" style="position:relative; float: left;">
            <div class="imgtop" style="width: 100%;">
            <img src="img/sc26.png" class="imgsc26"/>
            </div>
          </div>
          <div class="col-md-3"></div> 
          <div class="col-md-2"></div> 
          <div class="col-md-4" sytle="position:relative; float: right;">
            <div class="imgtop" style="width: 100%;">
            <img src="img/sc24.png" class="imgsc24"/>
            </div>
          </div>


          <div class="col-md-12">
            <table style="width:100%">
              <tr>
                <td>
                  <div class="imgtopsc26">
                    <img src="img/sc26.png"/>
                    </div>
                </td>
                <td>
                  <div class="imgtopsc26">
                    <img src="img/sc24.png"  />
                    </div>
                </td>
                
              </tr>
            </table>
            
           
          </div>
     



<div class="col-md-12">
  <div class="imgshow">
    <img src="img/sc25.png" class="sc25L"/>
  </div>
</div>
        </div>
      </div>
     </div>

    </div>
    <div class="col-md-4">
      <div  class="mt130"></div>
      <div class="imgtop">
      <img src="img/sc25.png" class="sc25L"/>
    </div>
    </div>
    
        
      </div>
  
  </div>
</div>

<noscript>This page does not work properly without javascript enabled. Please enable javascript.</noscript>
<script type="text/javascript" src="Modern_Mobster_ABI.js"></script>
<!--<script src="https://cdn.jsdelivr.net/npm/web3@latest/dist/web3.min.js"></script> 


integrity="sha512-/PTXSvaFzmO4So7Ghyq+DEZOz0sNLU4v1DP4gMOfY3kFu9L/IKoqSHZ6lNl3ZoZ7wT20io3vu/U4IchGcGIhfw=="
  crossorigin="anonymous"
  referrerpolicy="no-referrer"
-->
<script
  src="https://cdnjs.cloudflare.com/ajax/libs/web3/1.7.0-rc.0/web3.min.js"
  integrity="sha512-/PTXSvaFzmO4So7Ghyq+DEZOz0sNLU4v1DP4gMOfY3kFu9L/IKoqSHZ6lNl3ZoZ7wT20io3vu/U4IchGcGIhfw=="
  crossorigin="anonymous"
  referrerpolicy="no-referrer"
></script>

<script>





/*
 if (typeof window.ethereum !== 'undefined') { }
 ethereum.on('chainChanged', (_chainId) => window.location.reload());
ethereum.on('disconnect', (_disconnect) => window.location.reload());

//window.onload = getAccount;
getAccount();

}
else {
alert("Please install Metamask.");
}  
  
*/

async function checkConnection() {

    await ethereum
        .request({
            method: 'eth_accounts'
        })
        .then(account => {

            if (account[0] != null) {
                

                setTimeout(getAccount, 1000, account[0]);
            }
        })
        .catch(console.error);
}

window.onload = checkConnection();
connectButton = document.querySelector('.connectButton');
connectButton.addEventListener('click', getAccount);

async function getAccount() {

ethereum.on('chainChanged', (_chainId) => window.location.reload());
ethereum.on('disconnect', (_disconnect) => window.location.reload());

const chainId = await ethereum.request({ method: 'eth_chainId' });
//if (chainId === "0x89" || chainId === "0x137" || chainId === "0x80001" || chainId === "0x13881") { //for testing
//alert(chainId);
if (chainId === "0x89") { //0x4 is Rinkeby test network, 0x1 is Ethereum Mainnet, 137 is MATIC/polygon chainId === "0x89" || chainId === "0x137"

}
else {

return;
}

  const accounts = await ethereum.request({ method: 'eth_requestAccounts' }).catch((err) => {
      if (err.code === 4001) {
        // EIP-1193 userRejectedRequest error
        // If this happens, the user rejected the connection request.
        alert('Please connect to MetaMask.');
        console.log('Please connect to MetaMask.');
      } else {
        console.error(err);
      }
  });

      document.getElementById('connect').style.display = 'none';
      document.getElementById('mintNFT').style.display = 'block';

  const account = accounts[0];
  ethereum.on('accountsChanged', (_accounts) => window.location.reload());

//var contractAddress = "0x2A6f3a5D868D498b0e3ac16021c71a86FE80f63c"; //Matic Mumbai Ssecond Test
//var contractAddress = "0x5D5062A2CeBf0b9010c2d998DcDae49C5070590e"; //Matic Mumbai Test
//var contractAddress = "0xC7275a8F76B35f2D2c4F14C619f68f98Bb676043"; //Mobster Mainnet contract bricked
//var contractAddress = "0x679Ee2401a3d8d4776D59B6C49EeB4c7B230A1F6"; //Mobster Mainnet contract 
//var contractAddress ="0x19d5f97C875Cdd733C0e2e035fD66C2305A40CD3"; //Mobster Polygon Mainnet LOGOs
var contractAddress = "0xaD62ae8FfDD437F148Aed1efa439E912e669e2d6"; //Mobsters Polygon Mainnet 10k collection

var myAccountAddress = account;
//const web3 = new Web3("https://cloudflare-eth.com"); //ethereum mainnet only
const web3 = new Web3("https://speedy-nodes-nyc.moralis.io/3b81a677db4469eefdf52fbc/polygon/mainnet");
//const web3 = new Web3('https://polygon-mumbai.infura.io/v3/59d7368d4c0d46d7911cbfead3765ef1'); 
  var myContract = new web3.eth.Contract(contractABI, contractAddress, {
    from: myAccountAddress,
  });
 
var amount_left_to_mint = 0;
var cost = 0;
myContract.methods.maxSupply().call({from: myAccountAddress}, function(error, maxsupply){
 
  myContract.methods.totalSupply().call({from: myAccountAddress}, function(error, totalsupply){
    amount_left_to_mint = parseInt(maxsupply, 10) - parseInt(totalsupply, 10);

if (amount_left_to_mint > 0) { 
  mintNFTButton = document.querySelector('.mintNFTButton');

  myContract.methods.cost().call({from: myAccountAddress}, function(error, fee){
    cost = fee;

  var p = document.getElementById('amountLeft');
  p.innerHTML = (totalsupply-1) + "/" + maxsupply + " Mobsters Minted.<br>" + (cost/(10**18)).toString(10) + " MATIC each.";

  
  

  mintNFTButton.addEventListener('click', () => {
  
 
    var amount = parseInt(document.getElementById("amountNFTs").value, 10);
    if (amount_left_to_mint >= amount) {
      var transactioncost = cost * amount;
      var abiencoded = myContract.methods.mint(amount).encodeABI();

      const transactionParameters2 = {
        to: contractAddress,
        from: myAccountAddress, 
        value: web3.utils.toHex(transactioncost),
        data: abiencoded 
      };

      try {
        ethereum.request({ //await 
          method: "eth_sendTransaction",
          params: [transactionParameters2]
        });
        //setTimeout(window.location.reload(), 3000);
      } 
      catch (error) {
        alert("error");
      }
    }  
    else {
      var outputstr = "There are only " + amount_left_to_mint.toString(10) + " NFTs left to mint.";
      alert(outputstr);
    }
    
    });
  });
}
else {  
  //None left to mint
}
  
});
});

}//get accounts


</script> 


</body>
</html>
